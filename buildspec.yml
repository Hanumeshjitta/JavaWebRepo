version: 0.2

phases:
  install:
    commands:
      - apt-get update -y
      - apt-get install -y software-properties-common
      - add-apt-repository ppa:openjdk-r/ppa
      - apt-get update -y
      - apt-get install -y openjdk-8-jdk
      - apt-get install -y maven
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws --version
#      - export AWS_ACCESS_KEY_ID=AKIAI2OKWKM3H54LUXXQ
#     - export AWS_SECRET_ACCESS_KEY=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
      - echo $AWS_DEFAULT_REGION
#      - $(aws ecr get-login --region $AWS_DEFAULT_REGION)
      - docker login -u AWS -p eyJwYXlsb2FkIjoiUWRNZGVmUmFJcmhjR3k4OFNQOG5hTVprWFR4SDlwU3MyZTEvYjNpdGozU2E0VGhpVnViMDNKNWIydVE5blhIVFgvNXVoQmkxb21zRWFYSDBWVTMxM20va1MzY1g2eFZxWGRBQ2Z0VDhYSlljbWY3N3Z5OGlZYytxUUxkZTNWMFlPcVlBb1dBOTYrZUZkK0tBbWRxWnFENHZ0RFlpL21XaGJ1SFhweENaV2FNMTNybVUxTXRlelpZcFgxQnMxb09aV1BiaVVyYjlkS3BzTldlNmFuZGMwdmJwOFRxc0xJdCt2MUw5dEcyN3NKTHc1eUs0Y3BxclVOdnVxM09sd2ZEemlTY3RmL2ZLb2p5OVNKQ3V0eVhtSTMrVnJuYi9iam15R1RPUXZNakxpTi8vbjh6TzBkM3MyalVZaUVPTXBhSi9UYVNNQ0UxMkg3RFdROG8wNXhXWmlIR0UvN2FCam5wRGd5Q1RteTJVTmRTMkttRDVLbDhDSWk1SDFyaldHMDdSdmZhVDVJbEc5Skx6VktaMUJBR0dWdm1HOFZNZHJPd1N6TWJYbU1ELzBtWGxFSGFjU2o0VUF0RXltUWNhbWhLSnhBYUg5cE9QUmNGelRWRGtqMkVLQUVuTDZESERjU2IzeXJwdllkd1IzL2sxOVZKNUZEVmxwaEtkRG94VWphN1Z5S1pQaHJPRUhKckNvZG56dnU2aWtaRE05OHR4UVR3YndycG11a0gycUFWdFFXZ3p1S2ExRmlrL2JCZXRCYU15Yld6V2JJQmxnamVFdGdoeGNFdThNSFJTUlFBQncyRkpxaHVvUzJiWUVYVTkvdU5zd0F2TFJnM1U2UVkyZHhTL3AyTTdHUkdJZDVYTUMrRElQWnpWR0ZQd3BpamNETVJ1MVQxQ3plYU9hbEZTQy91RkxlUzZ6RlJSbEV6VHdUaUhiUzZKV25ZKzZtL1lHWHhxTnFTY1MyTnFPcGtCT0ZBVTdVNGgyRFgzK3RPQUNZWndMNitvUEt0U2o0WjFjQyt5VEtHc0dyNnUvTTlneHBGVWRoK0VjdmRnOWw4ODBkbVlJYzhoM0dEb2UrRzFLMVdoWnhTV2drbjNUWlpHYUFYdU13OWVHU2s5RmQreEt3VXNlQUtBZGRtSXVvMm5PVC9YblpkZjl1ZThzY0prNWhGblhlME5BSXkyVUlIR2MzbzRrcG16TndrVEFxT05nZnBKelRzcGNPbWVJd040aHIrR2loQWNJandqcGUycUlteWt5SXNqQXl3RnYrMVlSSTcrQnJERXVramo5WFNweEZjVFgwQzUzZEJyN3czODNUdXdEZzJ6VnVBTkNMSG9PaTFENHU1Vmh2OC96ZUwvR3Rrb1B1OXpZU0Z2dXVORG9xbUttSUJLYlhlMXFPeE1LbFRDQ2ZaS1FlWkthVk5RZVoxT2dhZFMrcUJyK2w2T2lWeU90Vk1sRkJzRjZCQUUxNjhGNm5RNm1kT0htSjZuTDJMNUhwaFNpM2s3cXhrQjhnPT0iLCJkYXRha2V5IjoiQVFFQkFIaHdtMFlhSVNKZVJ0Sm01bjFHNnVxZWVrWHVvWFhQZTVVRmNlOVJxOC8xNHdBQUFINHdmQVlKS29aSWh2Y05BUWNHb0c4d2JRSUJBREJvQmdrcWhraUc5dzBCQndFd0hnWUpZSVpJQVdVREJBRXVNQkVFRE5pckZjRG01d0d1TWVOV3hRSUJFSUE3NjJJMEdvc0g2NlpMQmU4bjlCTTlIQk5wdHE3aU5DWGN1NHAzcGhDWHRVR2NrK1ZNbmpra3EyMjRtb2EzQkdjTWFPRGJ0R3FvWmlUU0tyUT0iLCJ2ZXJzaW9uIjoiMiIsInR5cGUiOiJEQVRBX0tFWSIsImV4cGlyYXRpb24iOjE1MzkxMjI3MTh9  https://214472130589.dkr.ecr.us-east-1.amazonaws.com
      - REPOSITORY_URI=214472130589.dkr.ecr.us-east-1.amazonaws.com/helloworld
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
  build:
    commands:
      - echo Build started on `date`
      - echo Maven Build...
      - mvn install
      - echo $REPOSITORY_URI
      - echo Building the Docker image...          
      - docker build -t $REPOSITORY_URI:latest .
      - docker tag $REPOSITORY_URI:latest
#      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
  post_build:
    commands:
      - echo Build completed on `date`
      - mkdir appfiles
      - cd appfiles
      - cp ../target/JavaWeb.war .
      - cp ../imagedefinitions.json .
      - ls -al
      - tar -zcvf ../target/JavaWeb.tar.gz *.*
      - echo Pushing the Docker images...
      - docker push $REPOSITORY_URI:latest
#      - docker push $REPOSITORY_URI:$IMAGE_TAG
#      - echo Writing image definitions file...
#      - printf '[{"name":"helloworld","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
artifacts:
  files:
#    - imagedefinitions.json
#    - target/JavaWeb.war